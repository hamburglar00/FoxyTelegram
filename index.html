<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RED OFICIAL FOXY</title>
  <link rel="icon" href="imagenes/favicon.png" type="image/png" />
  <link rel="stylesheet" href="./styles.css" />
  <link rel="preconnect" href="https://connect.facebook.net" crossorigin>
  <link rel="dns-prefetch" href="//connect.facebook.net">
  <link rel="preload" href="imagenes/fondo.png" as="image">

  <!-- Meta Pixel Code (con coincidencias avanzadas) -->
  <script>
    function normEmail(v){return(v||"").trim().toLowerCase();}
    function normPhone(v){let p=(v||"").replace(/\D+/g,"");if(p&&p.length===10)p="54"+p;return p;}
    function safeUUID(){return crypto?.randomUUID?.()||
      "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,c=>{
        const r=Math.random()*16|0,v=c==="x"?r:r&0x3|0x8;
        return v.toString(16);
      });
    }
    function getOrCreateExternalId(){
      let id=localStorage.getItem("external_id");
      if(!id){id=safeUUID();localStorage.setItem("external_id",id);}
      return id;
    }

    const params=new URLSearchParams(location.search);
    const userEmail=normEmail(params.get("email"));
    const userPhone=normPhone(params.get("phone"));
    const externalId=getOrCreateExternalId();

    !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;t.src=v;
    s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)
    }(window,document,'script','https://connect.facebook.net/en_US/fbevents.js');

    window.fbq=window.fbq||function(){console.warn("Pixel no inicializado")};
    fbq("init","1158870522806554",{external_id:externalId,em:userEmail||void 0,ph:userPhone||void 0,country:"AR"});
    fbq("track","PageView");
  </script>

  <noscript>
    <img height="1" width="1" style="display:none"
      src="https://www.facebook.com/tr?id=1158870522806554&ev=PageView&noscript=1"/>
  </noscript>
</head>

<body>
  <div class="container background-image">
    <div class="overlay"></div>
    <div class="content">
      <img src="imagenes/logo.png" class="logo" alt="Logo Foxy"
           width="240" height="240" decoding="async" fetchpriority="high" />

      <p class="title">Envianos un WhatsApp<br />para crear tu usuario</p>

      <!-- 游댯 BOT칍N TELEGRAM -->
      <a class="telegram-button" id="telegramButton" href="#" rel="noopener noreferrer" aria-label="Crear usuario por Telegram">
        <span>춰CREAR USUARIO POR TELEGRAM!</span>
        <img src="imagenes/telegram.png" class="telegram-icon" alt="telegram" width="24" height="24" />
      </a>

      <!-- 游릭 BOT칍N WHATSAPP -->
      <a class="whatsapp-button" id="whatsappButton" href="#" rel="noopener noreferrer" aria-label="Crear usuario por WhatsApp">
        <span>춰CREAR USUARIO YA!</span>
        <img src="imagenes/whatsapp.png" class="whatsapp-icon" alt="whatsapp" width="24" height="24" />
      </a>

      <p class="subtitle">M칤nimo de $1.000<br />Sin M치ximo de Retiro<br />Gan치s y cobr치s a cualquier hora</p>
      <p class="description">-RED OFICIAL: FOXY-</p>
    </div>
  </div>

<!-- ESTILOS DEL BOT칍N TELEGRAM -->
<style>
.telegram-button {
  margin-top: 15px;
  display: flex;
  justify-content: center;
  align-items: center;
  background-color: #2AABEE;
  padding: 15px 22px;
  border-radius: 12px;
  font-size: 22px;
  font-weight: bold;
  color: white;
  text-decoration: none;
  cursor: pointer;
  box-shadow: 0 0 15px rgba(42,171,238,0.7);
  transition: transform .2s, box-shadow .2s;
}
.telegram-button:hover {
  transform: scale(1.04);
  box-shadow: 0 0 18px rgba(42,171,238,0.95);
}
.telegram-icon { margin-left: 10px; }
</style>

<script>
/*************** CONFIGURACI칍N ***************/
const CONFIG_FRONT = {
  SERVICE_URL: "/api/get-random-phone",
  FALLBACK: [{ number: "5493517699950", name: "Diana", weight: 1 }],
  TTL_MS: 5*60*1000,
  LS_KEY: "active_whatsapp_numbers:dianawin",
  ENVIAR_PROMO_CODE: true,
  LANDING_TAG: "DW2"
};

/*************** UTILIDADES ***************/
function fetchWithTimeout(url,opt={},ms=2000){
  const ctrl=new AbortController();const id=setTimeout(()=>ctrl.abort(),ms);
  return fetch(url,{...opt,signal:ctrl.signal}).finally(()=>clearTimeout(id));
}
const qs=new URLSearchParams(location.search);
const getQueryParam=p=>qs.get(p);
const getCookie=name=>{
  const m=document.cookie.match(new RegExp("(^| )"+name+"=([^;]+)"));return m&&m[2];
};
function getFbc(){
  const c=getCookie("_fbc");
  if(c){localStorage.setItem("stored_fbc",c);return c;}
  const s=localStorage.getItem("stored_fbc");if(s)return s;
  const fbclid=getQueryParam("fbclid");if(!fbclid)return;
  const fbc=`fb.1.${Date.now()}.${fbclid}`;
  localStorage.setItem("stored_fbc",fbc);return fbc;
}
function getFbp(){
  const c=getCookie("_fbp");
  if(c){localStorage.setItem("stored_fbp",c);return c;}
  const s=localStorage.getItem("stored_fbp");if(s)return s;
  const n=`fb.1.${Date.now()}.${Math.floor(Math.random()*1e10)}`;
  localStorage.setItem("stored_fbp",n);return n;
}
function generateUUID(){
  return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,c=>{
    const r=Math.random()*16|0,v=c==="x"?r:r&0x3|0x8;
    return v.toString(16);
  });
}
function getDeviceType(){
  const ua=navigator.userAgent;
  if(/mobile/i.test(ua))return"mobile";
  if(/tablet|ipad|playbook|silk/i.test(ua))return"tablet";
  return"desktop";
}
async function detectarGeo(timeoutMs=700){
  try{
    const ctrl=new AbortController();const t=setTimeout(()=>ctrl.abort(),timeoutMs);
    const res=await fetch("https://ipapi.co/json/",{signal:ctrl.signal,cache:"no-store"});
    clearTimeout(t);
    const d=await res.json();
    return{country:d.country,region:d.region,city:d.city};
  }catch{
    return{country:null,region:null,city:null};
  }
}

/*************** CARGA DE N칔MEROS ***************/
function getCache(){
  try{return JSON.parse(localStorage.getItem(CONFIG_FRONT.LS_KEY)||"null");}catch{return null;}
}
function setCache(numbers){
  localStorage.setItem(CONFIG_FRONT.LS_KEY,JSON.stringify({ts:Date.now(),numbers}));
}
function normalizeNumbers(list){
  return(Array.isArray(list)?list:[])
    .map(n=>({number:String(n.number||n.phone||"").trim(),weight:Number(n.weight||1),name:n.name||"Diana"}))
    .filter(n=>/^\+?\d{8,17}$/.test(n.number));
}
async function loadNumbersOnce(){
  const cached=getCache();
  try{
    const res=await fetchWithTimeout(CONFIG_FRONT.SERVICE_URL,{headers:{"Cache-Control":"no-store"}},2000);
    if(!res.ok)throw new Error("HTTP "+res.status);
    const data=await res.json();
    const list=normalizeNumbers(Array.isArray(data)?data:[data]);
    if(list.length){setCache(list);return list;}
    throw new Error("Invalid");
  }catch{
    const ok=cached?.numbers?.length&&Date.now()-(cached.ts||0)<CONFIG_FRONT.TTL_MS;
    return ok?cached.numbers:CONFIG_FRONT.FALLBACK;
  }
}
function pickWeightedRandom(list){
  const total=list.reduce((s,it)=>s+(Number(it.weight)||1),0);
  let r=Math.random()*total;
  for(const it of list){
    r-=Number(it.weight||1);
    if(r<=0)return it;
  }
  return list[list.length-1];
}

/*************** PRINCIPAL ***************/
document.addEventListener("DOMContentLoaded",()=>{

  /**************************************
   游댯 BOT칍N TELEGRAM con tracking FULL
  **************************************/
  const tg=document.getElementById("telegramButton");

  tg.addEventListener("click",async e=>{
    e.preventDefault();

    // 游댳 Telegram username (cambiar)
    const tgUser="FoxyCasinoBot";

    // 游댳 No depende de n칰meros din치micos
    const assigned="TELEGRAM";

    const event_id=generateUUID();
    const external_id=getOrCreateExternalId();
    const event_source_url=location.href;
    const fbp=getFbp();
    const fbc=getFbc();
    const uuidSegment=generateUUID().replace(/-/g,"").slice(0,12);
    const promo_code=CONFIG_FRONT.ENVIAR_PROMO_CODE?`${CONFIG_FRONT.LANDING_TAG}-${uuidSegment}`:"";

    if(window.fbq){
      fbq("track","Contact",{
        content_name:"Bot칩n Telegram",
        content_category:"LeadGen",
        event_source:"Landing DianaWin"
      });
    }

    detectarGeo().then(geo=>{
      const payload={
        event_name:"Contact_Telegram",
        event_id,
        external_id,
        event_source_url,
        fbp,
        fbc,
        email:getQueryParam("email"),
        phone:getQueryParam("phone"),
        fn:getQueryParam("fn"),
        ln:getQueryParam("ln"),
        ct:getQueryParam("ct"),
        st:getQueryParam("st"),
        zip:getQueryParam("zip"),
        country:getQueryParam("country"),
        geo_city:geo.city,
        geo_region:geo.region,
        geo_country:geo.country,
        utm_campaign:getQueryParam("utm_campaign"),
        telefono_asignado:assigned,
        device_type:getDeviceType(),
        promo_code
      };

      fetch("/api/xz3v2q",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(payload),
        keepalive:true
      }).catch(console.error);
    });

    // abrir telegram
    setTimeout(()=>{
      window.open(`https://t.me/${tgUser}`,"_blank","noopener");
    },200);

  });



  /**************************************
   游릭 BOT칍N WHATSAPP (igual que antes)
  **************************************/
  const btn=document.getElementById("whatsappButton");
  let waInFlight=false,activeNumbers=[];
  loadNumbersOnce().then(list=>activeNumbers=list);

  btn.addEventListener("click",async e=>{
    e.preventDefault();if(waInFlight)return;waInFlight=true;

    const {number:telefono,name:botName}=activeNumbers.length?pickWeightedRandom(activeNumbers):CONFIG_FRONT.FALLBACK[0];
    const cleanPhone=telefono.replace("+","").trim();
    const external_id=getOrCreateExternalId();
    const event_id=generateUUID();
    const event_source_url=location.href;
    const fbp=getFbp();
    const fbc=getFbc();
    const uuidSegment=generateUUID().replace(/-/g,"").slice(0,12);
    const promo_code=CONFIG_FRONT.ENVIAR_PROMO_CODE?`${CONFIG_FRONT.LANDING_TAG}-${uuidSegment}`:"";

    const variantes=[
      n=>`Hola ${n}! Vi este anuncio, me pas치s info?`,
      n=>`Hola ${n}! Vi el anuncio, podr칤as darme m치s info?`,
      n=>`Buenas ${n}! Me cont치s un poco m치s del anuncio?`
    ];
    const base=variantes[Math.floor(Math.random()*variantes.length)](botName);
    const mensaje=promo_code?`${base} ${promo_code}`:base;

    if(window.fbq){
      fbq("track","Contact",{content_name:"Bot칩n WhatsApp",content_category:"LeadGen"});
    }

    setTimeout(()=>{
      window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(mensaje)}`,"_blank","noopener");
    },200);

    detectarGeo().then(geo=>{
      const payload={
        event_name:"Contact",
        event_id,
        external_id,
        event_source_url,
        fbp,
        fbc,
        email:getQueryParam("email"),
        phone:getQueryParam("phone"),
        fn:getQueryParam("fn"),
        ln:getQueryParam("ln"),
        ct:getQueryParam("ct"),
        st:getQueryParam("st"),
        zip:getQueryParam("zip"),
        country:getQueryParam("country"),
        geo_city:geo.city,
        geo_region:geo.region,
        geo_country:geo.country,
        utm_campaign:getQueryParam("utm_campaign"),
        telefono_asignado:cleanPhone,
        device_type:getDeviceType(),
        promo_code
      };

      fetch("/api/xz3v2q",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(payload),
        keepalive:true
      })
      .finally(()=>setTimeout(()=>waInFlight=false,800));
    });
  });

});
</script>

</body>
</html>
